{% extends "base.html" %}

{% block title %}Analyst Evaluation Dashboard{% endblock %}

{% block extra_head %}
<style>.completed {
  display: none;
}

.decision-text {
  background-color: #e9ecef;
  border-left: 4px solid #6c757d;
  border-radius: 0.375rem;
  margin-bottom: 1.5rem;
  padding: 1rem;
}

.evaluation-body {
  padding: 1.5rem;
}

.evaluation-container {
  border-radius: 0.5rem;
  border: 1px solid #ddd;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  margin-bottom: 2rem;
}

.evaluation-header {
  background-color: #f1f3f5;
  border-bottom: 1px solid #ddd;
  border-radius: 0.5rem 0.5rem 0 0;
  padding: 1rem;
}

.is-invalid {
  border-color: #dc3545;
}

.model-label {
  font-weight: 600;
  width: 120px;
}

.model-questions-container {
  margin-bottom: 2rem;
}

.question-item {
  line-height: 1.5;
  margin-bottom: 0.5rem;
}

.question-list {
  list-style-type: decimal;
  margin-top: 1rem;
  padding-left: 1.25rem;
}

.rating-criteria {
  display: flex;
  flex-grow: 1;
  justify-content: space-between;
}

.rating-item {
  align-items: center;
  display: flex;
  flex-direction: column;
  margin: 0 0.3rem;
}

.rating-row {
  align-items: center;
  background-color: #f8f9fa;
  border-radius: 0.375rem;
  display: flex;
  margin-bottom: 1rem;
  padding: 0.75rem;
}

.rating-select {
  font-size: 0.9rem;
  padding-right: 20px;
  width: 75px;
}

.rating-select option {
  padding: 2px 5px;
}

.sticky-bar {
  background-color: white;
  border-top: 1px solid #ddd;
  bottom: 0;
  box-shadow: 0 -0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  margin-top: 2rem;
  padding: 1rem;
  position: sticky;
  z-index: 100;
}
</style>
{% endblock %}

{% block content %}
<div class="container mb-5 pb-5">
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Analyst Evaluation Dashboard</h2>
                <div>
                    <span class="badge bg-info">User ID: {{ user_id }}</span>
                </div>
            </div>
            <p class="lead">Please review and evaluate the question sets generated by different models for each
                decision.</p>

            <div class="alert alert-info">
                <h5 class="alert-heading">Evaluation Instructions</h5>
                <p>For each decision scenario:</p>
                <ol>
                    <li>Read the decision carefully</li>
                    <li>Review all of the question sets (labeled as Model A, B, C, D, and E)</li>
                    <li>Rate each model on various criteria using the dropdown selectors</li>
                    <li>Submit your evaluation before proceeding to the next decision</li>
                </ol>
                <p class="mb-0">You have been assigned <strong>{{ evaluations|length }}</strong> decision(s) to
                    evaluate.</p>
            </div>
        </div>
    </div>

    
    
    {% if all_completed %}
    <div class="alert alert-success mb-4" id="all-completed-message">
        <h4 class="alert-heading"><i class="fas fa-check-circle me-2"></i>All Evaluations Completed!</h4>
        <p>Thank you for completing all your assigned evaluations. Your feedback is invaluable to our research.</p>
        <hr>
        <p class="mb-0" id="completion-code-placeholder">You may now close this window or return to the <a href="{{ url_for('hello.index') }}">home page</a>.</p>
    </div>
    {% endif %}

    
    {% for eval in evaluations %}
    <div class="evaluation-container {% if eval.is_completed %}completed{% endif %}" id="evaluation-{{ eval.id }}" data-eval-id="{{ eval.id }}">
        <div class="evaluation-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Decision #{{ loop.index }}</h3>
                <span class="badge {% if eval.is_completed %}bg-success{% else %}bg-warning text-dark{% endif %}" id="badge-{{ eval.id }}">
                    {% if eval.is_completed %}Completed{% else %}Pending{% endif %}
                </span>
            </div>
        </div>

        <div class="evaluation-body">
            
            <div class="mb-4">
                <h4>Decision Context:</h4>
                <div class="decision-text">
                    {{ eval.decision_text }}
                </div>
            </div>

            
            <div class="model-questions-container">
                <h4 class="mb-3">Question Sets by Model:</h4>

                
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    {% set model_labels = ['A', 'B', 'C', 'D', 'E'] %}
                    {% for i in range(1, 6) %}
                    {% set model_key = 'model_' ~ i %}
                    {% if model_key in eval.models_data %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if loop.first %}active{% endif %}" id="model{{ i }}-tab-{{ eval.id }}" data-bs-toggle="tab" data-bs-target="#model{{ i }}-content-{{ eval.id }}" type="button" role="tab" aria-controls="model{{ i }}-content-{{ eval.id }}" aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                            Model {{ model_labels[i-1] }}
                        </button>
                    </li>
                    {% endif %}
                    {% endfor %}
                </ul>

                
                <div class="tab-content border border-top-0 p-3 bg-light">
                    {% for i in range(1, 6) %}
                    {% set model_key = 'model_' ~ i %}
                    {% if model_key in eval.models_data %}
                    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="model{{ i }}-content-{{ eval.id }}" role="tabpanel" aria-labelledby="model{{ i }}-tab-{{ eval.id }}">
                        <ol class="question-list">
                            {% for question_item in eval.models_data[model_key] %}
                            <li class="question-item">{{ question_item.question }}</li>
                            {% endfor %}
                        </ol>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            
            {% if not eval.is_completed %}
            <form id="evaluation-form-{{ eval.id }}" class="rating-form">
                <input type="hidden" name="evaluation_id" value="{{ eval.id }}">

                <h4 class="mb-3">Evaluation Criteria:</h4>

                
                {% set model_labels = ['A', 'B', 'C', 'D', 'E'] %}
                {% for i in range(1, 6) %}
                {% set model_key = 'model_' ~ i %}
                {% if model_key in eval.models_data %}
                <div class="rating-row" id="model-row-{{ eval.id }}-{{ i }}">
                    <div class="model-label">Model {{ model_labels[i-1] }}:</div>
                    <div class="rating-criteria">
                        <div class="rating-item">
                            <label class="small mb-1">Accuracy</label>
                            <select class="form-select rating-select" name="ratings[model{{ i }}][accuracy]" required>
                                <option value selected disabled>Rate</option>
                                <option value="1">1 - Low</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - High</option>
                            </select>
                        </div>

                        <div class="rating-item">
                            <label class="small mb-1">Concreteness</label>
                            <select class="form-select rating-select" name="ratings[model{{ i }}][concreteness]" required>
                                <option value selected disabled>Rate</option>
                                <option value="1">1 - Vague</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - Specific</option>
                            </select>
                        </div>

                        <div class="rating-item">
                            <label class="small mb-1">Comprehensiveness</label>
                            <select class="form-select rating-select" name="ratings[model{{ i }}][comprehensiveness]" required>
                                <option value selected disabled>Rate</option>
                                <option value="1">1 - Narrow</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - Thorough</option>
                            </select>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}

                
                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-primary py-2 submit-all-models" data-eval-id="{{ eval.id }}">
                        <i class="fas fa-save me-2"></i>Submit Evaluation
                    </button>
                </div>
            </form>

            
            <div id="success-message-{{ eval.id }}" class="alert alert-success mt-3" style="display: none;">
                <i class="fas fa-check-circle me-2"></i>Evaluation submitted successfully!
            </div>

            
            <div id="error-message-{{ eval.id }}" class="alert alert-danger mt-3" style="display: none;"></div>
            {% else %}
            
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>You have already completed this evaluation. Thank you for your
                feedback!
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    
    <div class="sticky-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>Progress:</strong> <span id="completion-counter">{{ evaluations|selectattr('is_completed', 'equalto', true)|list|length }}</span>
                    of {{ evaluations|length }} evaluations completed
                </div>
                <div>
                    <button id="scroll-to-next" class="btn btn-primary">
                        <i class="fas fa-arrow-down me-2"></i>Next Unevaluated Decision
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const evalStatus = {};

        document.querySelectorAll('.evaluation-container').forEach(container => {
            const evalId = container.dataset.evalId;
            evalStatus[evalId] = {
                completed: container.classList.contains('completed')
            };
        });

        const totalEvaluations = document.querySelectorAll('.evaluation-container').length;

        document.querySelectorAll('.rating-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const evalId = formData.get('evaluation_id');

                const ratings = {};
                let isComplete = true;

                const modelSelects = {};
                form.querySelectorAll('select[name^="ratings["]').forEach(select => {
                    const modelMatch = select.name.match(/ratings\[(.+?)\]\[.+?\]/);
                    if (modelMatch) {
                        const model = modelMatch[1];
                        if (!modelSelects[model]) {
                            modelSelects[model] = [];
                        }
                        modelSelects[model].push(select);
                    }
                });

                Object.entries(modelSelects).forEach(([model, selects]) => {
                    const hasAnyValue = selects.some(select => select.value);

                    if (hasAnyValue) {
                        selects.forEach(select => {
                            if (!select.value) {
                                isComplete = false;
                                select.classList.add('is-invalid');
                            } else {
                                select.classList.remove('is-invalid');

                                const criterionMatch = select.name.match(/ratings\[.+?\]\[(.+?)\]/);
                                if (criterionMatch) {
                                    const criterion = criterionMatch[1];
                                    if (!ratings[model]) {
                                        ratings[model] = {};
                                    }
                                    ratings[model][criterion] = parseInt(select.value);
                                }
                            }
                        });
                    }
                });

                if (Object.keys(ratings).length === 0) {
                    isComplete = false;
                    const errorEl = document.getElementById(`error-message-${evalId}`);
                    errorEl.textContent = 'Please rate at least one model';
                    errorEl.style.display = 'block';
                    return;
                }

                if (!isComplete) {
                    const errorEl = document.getElementById(`error-message-${evalId}`);
                    errorEl.textContent = 'Please complete all ratings for any model you start rating';
                    errorEl.style.display = 'block';
                    return;
                }

                submitDecisionRatings(evalId, ratings);
            });
        });

        function submitDecisionRatings(evalId, ratings) {
            const errorEl = document.getElementById(`error-message-${evalId}`);
            errorEl.style.display = 'none';

            const button = document.querySelector(`.submit-all-models[data-eval-id="${evalId}"]`);
            if (button) {
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Submitting...';
            }

            fetch('/api/analyst_feedback/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    evaluation_id: evalId,
                    ratings: ratings
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        evalStatus[evalId].completed = true;

                        const successMsg = document.getElementById(`success-message-${evalId}`);
                        successMsg.textContent = 'Evaluation submitted successfully!';
                        successMsg.style.display = 'block';

                        const badge = document.getElementById(`badge-${evalId}`);
                        badge.className = 'badge bg-success';
                        badge.textContent = 'Completed';

                        setTimeout(() => {
                            const evalContainer = document.getElementById(`evaluation-${evalId}`);
                            evalContainer.classList.add('completed');

                            const completedCount = Object.values(evalStatus).filter(status => status.completed).length;
                            document.getElementById('completion-counter').textContent = completedCount;

                            if (completedCount === totalEvaluations || data.all_completed) {
                                if (data.completion_code) {
                                    const completionMsg = document.createElement('div');
                                    completionMsg.className = 'alert alert-success mt-4';
                                    completionMsg.innerHTML = `
                        <h4 class="alert-heading"><i class="fas fa-check-circle me-2"></i>All Evaluations Completed!</h4>
                        <p>Thank you for completing all your assigned evaluations. Your feedback is invaluable to our research.</p>
                        <hr>
                        <p>Your Prolific completion code is: <strong>${data.completion_code}</strong></p>
                        <p class="mb-0">Please enter this code on Prolific to confirm you've completed the task.</p>
                    `;

                                    const container = document.querySelector('.container');
                                    if (container) {
                                        container.insertBefore(completionMsg, container.firstChild);
                                        window.scrollTo(0, 0);
                                    }
                                }

                                setTimeout(() => location.reload(), 2000);
                            } else {
                                scrollToNextEvaluation();
                            }
                        }, 2000);
                    } else {
                        errorEl.textContent = data.error || 'An error occurred while submitting your evaluation.';
                        errorEl.style.display = 'block';

                        if (button) {
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-save me-2"></i>Submit Evaluation';
                        }
                    }
                }).catch(error => {
                console.error('Error:', error);
                errorEl.textContent = 'A network error occurred. Please try again.';
                errorEl.style.display = 'block';

                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-save me-2"></i>Submit Evaluation';
                }
            });
        }

        function scrollToNextEvaluation() {
            const pendingEvals = document.querySelectorAll('.evaluation-container:not(.completed)');
            if (pendingEvals.length > 0) {
                pendingEvals[0].scrollIntoView({behavior: 'smooth'});
            }
        }

        document.getElementById('scroll-to-next').addEventListener('click', scrollToNextEvaluation);
    });
    const allCompletedMessage = document.getElementById('all-completed-message');
    if (allCompletedMessage) {
        fetch('/api/analyst_feedback/status')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.all_completed && data.completion_code) {
                    const placeholder = document.getElementById('completion-code-placeholder');
                    if (placeholder) {
                        placeholder.innerHTML = `
                        Your completion code is: <strong>${data.completion_code}</strong><br>
                        Please enter this code to confirm you've completed the task.
                    `;
                    }
                }
            })
            .catch(error => {
                console.error('Error checking completion status:', error);
            });
    }
</script>
{% endblock %}